{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/ref.ts"],
  "sourcesContent": ["import { Link } from './ref'\n\ntype Fn = (...args: any[]) => any\n\nexport interface Sub {\n  deps: Link | undefined\n  depsTail: Link | undefined\n}\n\nexport let activeSub: ReactiveEffect\nexport class ReactiveEffect implements Sub {\n  deps: Link | undefined\n  depsTail: Link | undefined\n  constructor(public fn: Fn) {}\n  run() {\n    /**\n     * prevSub \u89E3\u51B3effect\u5D4C\u5957\u8C03\u7528, activeSub \u6307\u5411\u95EE\u9898\n     */\n    const prevSub = activeSub\n    activeSub = this\n    this.depsTail = undefined\n    try {\n      this.fn()\n    } finally {\n      activeSub = prevSub\n    }\n  }\n  notify() {\n    this.scheduler()\n  }\n  scheduler() {\n    this.run()\n  }\n}\n\ninterface EffectOptions {\n  scheduler?: Fn\n}\nexport function effect(fn: Fn, options?: EffectOptions) {\n  const eff = new ReactiveEffect(fn)\n  Object.assign(eff, options)\n\n  eff.run()\n\n  const runner = eff.run.bind(eff)\n  runner.effect = eff\n  return runner\n}\n", "import { activeSub, ReactiveEffect, Sub } from './effect'\n\nexport interface Link {\n  dep: Dep | undefined\n  prevSub: Link | undefined\n  nextSub: Link | undefined\n\n  sub: ReactiveEffect | undefined\n  nextDep: Link | undefined\n}\n\nclass Dep {\n  subs: Link\n  subsTail: Link\n  constructor() {}\n}\n\nclass RefImpl {\n  _value\n  dep: Dep\n  constructor(value: any) {\n    this._value = value\n    this.dep = new Dep(this)\n  }\n  get value() {\n    track(this)\n    return this._value\n  }\n  set value(newValue: any) {\n    this._value = newValue\n    trigger(this)\n  }\n}\n\nexport function ref(val: any) {\n  return new RefImpl(val)\n}\n\nfunction track(refImpl: RefImpl) {\n  if (activeSub) {\n    link(refImpl.dep, activeSub)\n  }\n}\n\nfunction link(dep: Dep, sub: ReactiveEffect) {\n  /**\n   * \u4F9D\u8D56\u6027\u7684\u526F\u4F5C\u7528\u51FD\u6570link\u8282\u70B9\u590D\u7528 (\u6A2A\u5411\u590D\u7528), \u987A\u5E26\u89E3\u51B3\u7EB5\u5411\u91CD\u590D\u95EE\u9898, \u56E0\u4E3Areturn\u4E86\n   * \u89E3\u51B3\u591A\u6B21\u89E6\u53D1\u526F\u4F5C\u7528\u51FD\u6570, \u91CD\u590D\u6536\u96C6\u4F9D\u8D56\u7684\u95EE\u9898\n   * sub.depsTail \u5728 run \u5F00\u59CB\u65F6\u91CD\u7F6E\u4E3A\u4E86 undefined, \u8868\u793A\u526F\u4F5C\u7528\u51FD\u6570\u4ECE\u5934\u5F00\u59CB, \u6309\u8BBF\u95EE\u987A\u5E8F\u6536\u96C6\u4F9D\u8D56\n   * 1. \u5934\u8282\u70B9\u590D\u7528\n   * 2. \u5C3E\u8282\u70B9\u590D\u7528\n   */\n  // \u5C1D\u8BD5\u590D\u7528\u539F\u59CB\u5934\u8282\u70B9\n  if (sub.depsTail === undefined) {\n    if (sub.deps) {\n      if (sub.deps.dep === dep) {\n        sub.depsTail = sub.deps\n        return\n      }\n    }\n  } else {\n    // \u5C1D\u8BD5\u590D\u7528\u5C3E\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A\u8282\u70B9\n    if (sub.depsTail.nextDep && sub.depsTail.nextDep.dep === dep) {\n      sub.depsTail = sub.depsTail.nextDep\n      return\n    }\n  }\n\n  let newLink: Link = {\n    dep,\n    prevSub: undefined,\n    nextSub: undefined,\n\n    sub,\n    nextDep: undefined,\n  }\n\n  /**\n   * \u7ED1\u5B9A\u4F9D\u8D56\u7684\u526F\u4F5C\u7528\u51FD\u6570\u94FE\u8868\u5173\u7CFB\n   * 1. \u6CA1\u6709\u5C3E\u8282\u70B9, \u8BF4\u660E\u9996\u6B21\u6DFB\u52A0, \u5F80\u5934\u8282\u70B9\u6DFB\u52A0, \u9996\u5C3E\u76F8\u540C\n   * 2. \u6709\u5C3E\u8282\u70B9, \u5F80\u5C3E\u8282\u70B9\u540E\u9762\u6DFB\u52A0, \u66F4\u65B0\u5C3E\u8282\u70B9\u6307\u9488\n   */\n  if (!dep.subsTail) {\n    dep.subs = newLink\n    dep.subsTail = newLink\n  } else {\n    // \u5411\u5C3E\u8282\u70B9\u540E\u9762\u6DFB\u52A0\n    dep.subsTail.nextSub = newLink\n    // \u5C06\u65B0\u8282\u70B9\u7684\u4E0A\u4E00\u4E2A\u6307\u5411\u5C3E\u8282\u70B9\n    newLink.prevSub = dep.subsTail\n    // \u66F4\u65B0\u5C3E\u8282\u70B9\u6307\u9488\n    dep.subsTail = newLink\n  }\n\n  /**\n   * \u7ED1\u5B9A\u526F\u4F5C\u7528\u51FD\u6570\u7684\u4F9D\u8D56\u94FE\u8868\u5173\u7CFB\n   * 1. \u6CA1\u6709\u5C3E\u8282\u70B9, \u8BF4\u660E\u9996\u6B21\u6DFB\u52A0, \u5F80\u5934\u8282\u70B9\u6DFB\u52A0, \u9996\u5C3E\u76F8\u540C\n   * 2. \u6709\u5C3E\u8282\u70B9, \u5F80\u5C3E\u8282\u70B9\u6DFB\u52A0, \u66F4\u65B0\u5C3E\u8282\u70B9\u6307\u9488\n   */\n  if (!sub.depsTail) {\n    sub.deps = newLink\n    sub.depsTail = newLink\n  } else {\n    // \u5411\u5C3E\u8282\u70B9\u540E\u9762\u6DFB\u52A0\n    sub.depsTail.nextDep = newLink\n    sub.depsTail = newLink\n  }\n}\n\nfunction trigger(refImpl: RefImpl) {\n  let link = refImpl.dep.subs\n  const queuedEffect = []\n  while (link) {\n    // debugger\n    const sub = link.sub\n    queuedEffect.push(sub)\n    link = link.nextSub\n  }\n  queuedEffect.forEach(sub => sub.notify())\n}\n"],
  "mappings": ";AASO,IAAI;AACJ,IAAM,iBAAN,MAAoC;AAAA,EAGzC,YAAmB,IAAQ;AAAR;AAAA,EAAS;AAAA,EAF5B;AAAA,EACA;AAAA,EAEA,MAAM;AAIJ,UAAM,UAAU;AAChB,gBAAY;AACZ,SAAK,WAAW;AAChB,QAAI;AACF,WAAK,GAAG;AAAA,IACV,UAAE;AACA,kBAAY;AAAA,IACd;AAAA,EACF;AAAA,EACA,SAAS;AACP,SAAK,UAAU;AAAA,EACjB;AAAA,EACA,YAAY;AACV,SAAK,IAAI;AAAA,EACX;AACF;AAKO,SAAS,OAAO,IAAQ,SAAyB;AACtD,QAAM,MAAM,IAAI,eAAe,EAAE;AACjC,SAAO,OAAO,KAAK,OAAO;AAE1B,MAAI,IAAI;AAER,QAAM,SAAS,IAAI,IAAI,KAAK,GAAG;AAC/B,SAAO,SAAS;AAChB,SAAO;AACT;;;ACpCA,IAAM,MAAN,MAAU;AAAA,EACR;AAAA,EACA;AAAA,EACA,cAAc;AAAA,EAAC;AACjB;AAEA,IAAM,UAAN,MAAc;AAAA,EACZ;AAAA,EACA;AAAA,EACA,YAAY,OAAY;AACtB,SAAK,SAAS;AACd,SAAK,MAAM,IAAI,IAAI,IAAI;AAAA,EACzB;AAAA,EACA,IAAI,QAAQ;AACV,UAAM,IAAI;AACV,WAAO,KAAK;AAAA,EACd;AAAA,EACA,IAAI,MAAM,UAAe;AACvB,SAAK,SAAS;AACd,YAAQ,IAAI;AAAA,EACd;AACF;AAEO,SAAS,IAAI,KAAU;AAC5B,SAAO,IAAI,QAAQ,GAAG;AACxB;AAEA,SAAS,MAAM,SAAkB;AAC/B,MAAI,WAAW;AACb,SAAK,QAAQ,KAAK,SAAS;AAAA,EAC7B;AACF;AAEA,SAAS,KAAK,KAAU,KAAqB;AAS3C,MAAI,IAAI,aAAa,QAAW;AAC9B,QAAI,IAAI,MAAM;AACZ,UAAI,IAAI,KAAK,QAAQ,KAAK;AACxB,YAAI,WAAW,IAAI;AACnB;AAAA,MACF;AAAA,IACF;AAAA,EACF,OAAO;AAEL,QAAI,IAAI,SAAS,WAAW,IAAI,SAAS,QAAQ,QAAQ,KAAK;AAC5D,UAAI,WAAW,IAAI,SAAS;AAC5B;AAAA,IACF;AAAA,EACF;AAEA,MAAI,UAAgB;AAAA,IAClB;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,IAET;AAAA,IACA,SAAS;AAAA,EACX;AAOA,MAAI,CAAC,IAAI,UAAU;AACjB,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB,OAAO;AAEL,QAAI,SAAS,UAAU;AAEvB,YAAQ,UAAU,IAAI;AAEtB,QAAI,WAAW;AAAA,EACjB;AAOA,MAAI,CAAC,IAAI,UAAU;AACjB,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB,OAAO;AAEL,QAAI,SAAS,UAAU;AACvB,QAAI,WAAW;AAAA,EACjB;AACF;AAEA,SAAS,QAAQ,SAAkB;AACjC,MAAIA,QAAO,QAAQ,IAAI;AACvB,QAAM,eAAe,CAAC;AACtB,SAAOA,OAAM;AAEX,UAAM,MAAMA,MAAK;AACjB,iBAAa,KAAK,GAAG;AACrB,IAAAA,QAAOA,MAAK;AAAA,EACd;AACA,eAAa,QAAQ,SAAO,IAAI,OAAO,CAAC;AAC1C;",
  "names": ["link"]
}
