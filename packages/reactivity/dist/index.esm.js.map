{
  "version": 3,
  "sources": ["../src/system.ts", "../src/effect.ts", "../src/ref.ts"],
  "sourcesContent": ["import { ReactiveEffect } from './effect'\n\nexport class Dep {\n  subs: Link | undefined\n  subsTail: Link | undefined\n}\n\nexport class Link {\n  dep: Dep\n  sub: ReactiveEffect\n  nextSub: Link | undefined\n  prevSub: Link | undefined\n  nextDep: Link | undefined\n\n  constructor(dep: Dep, sub: ReactiveEffect) {\n    this.dep = dep\n    this.sub = sub\n  }\n}\n\n/**\n * \u94FE\u63A5\u94FE\u8868\u5173\u7CFB\n * @param dep\n * @param sub\n */\nexport function link(dep: Dep, sub: ReactiveEffect) {\n  const currentDep = sub.depsTail\n  const nextDep = currentDep === undefined ? sub.deps : currentDep.nextDep\n\n  if (nextDep && nextDep.dep === dep) {\n    sub.depsTail = nextDep\n    return\n  }\n\n  const link = new Link(dep, sub)\n\n  // \u5C06\u672A\u88AB\u590D\u7528\u7684\u8282\u70B9\u653E\u5728\u5F53\u524D\u8282\u70B9\u7684\u540E\u9762, \u7528\u4E8E\u6E05\u7406\n  link.nextDep = nextDep\n\n  /**\n   * \u5173\u8054\u94FE\u8868\u548Cdep\u7684\u5173\u7CFB, \u5206\u4E24\u79CD\u60C5\u51B5\n   * 1. \u5C3E\u8282\u70B9\u6CA1\u6709, \u5219\u8868\u793A\u7B2C\u4E00\u6B21\u5173\u8054, \u90A3\u5C31\u5F80\u5934\u8282\u70B9\u52A0, \u5934\u5C3E\u76F8\u540C\n   * 2. \u5C3E\u8282\u70B9\u6709, \u90A3\u5C31\u5F80\u5C3E\u8282\u70B9\u540E\u9762\u52A0, \u5E76\u4E14\u66F4\u65B0\u5C3E\u6307\u9488\n   */\n  if (!dep.subsTail) {\n    dep.subs = link\n    dep.subsTail = link\n  } else {\n    dep.subsTail.nextSub = link\n    link.prevSub = dep.subsTail\n    dep.subsTail = link\n  }\n\n  /**\n   * \u5173\u8054\u94FE\u8868\u548Csub\u7684\u5173\u7CFB,\u5206\u4E24\u79CD\u60C5\u51B5\n   * 1. \u5C3E\u8282\u70B9\u6CA1\u6709, \u5219\u8868\u793A\u7B2C\u4E00\u6B21\u5173\u8054, \u90A3\u5C31\u5F80\u5934\u8282\u70B9\u52A0, \u5934\u5C3E\u76F8\u540C\n   * 2. \u5C3E\u8282\u70B9\u6709, \u90A3\u5C31\u5F80\u5C3E\u8282\u70B9\u540E\u9762\u52A0, \u5E76\u4E14\u66F4\u65B0\u5C3E\u6307\u9488\n   */\n  if (!sub.depsTail) {\n    sub.deps = link\n    sub.depsTail = link\n  } else {\n    sub.depsTail.nextDep = link\n    sub.depsTail = link\n  }\n}\n\n/**\n * \u4F20\u64AD\u66F4\u65B0\u7684\u51FD\u6570\n * @param subs\n */\nexport function propagate(subs: Link) {\n  let link = subs\n  const queuedEffects = []\n  while (link) {\n    const sub = link.sub\n    if (!sub.tracking) {\n      queuedEffects.push(sub)\n    }\n    link = link.nextSub\n  }\n  queuedEffects.forEach(effect => effect.notify())\n}\n\n/**\n * \u5F00\u59CB\u8FFD\u8E2A\u4F9D\u8D56, \u5C06depsTail\u5C3E\u8282\u70B9\u8BBE\u7F6E\u6210undefined\n * @param sub\n */\nexport function startTrack(sub: ReactiveEffect) {\n  sub.tracking = true\n  // \u526F\u4F5C\u7528\u51FD\u6570\u9996\u6B21\u6216\u91CD\u590D\u6267\u884C\u65F6, \u5C06\u5C3E\u8282\u70B9\u7F6E\u4E3A\u7A7A, \u5F00\u59CB\u91CD\u65B0\u6536\u96C6\u4F9D\u8D56\n  sub.depsTail = undefined\n}\n\n/**\n * \u7ED3\u675F\u8FFD\u8E2A\uFF0C\u627E\u5230\u9700\u8981\u6E05\u7406\u7684\u4F9D\u8D56\uFF0C\u65AD\u5F00\u5173\u8054\u5173\u7CFB\n * @param sub\n */\nexport function endTrack(sub: ReactiveEffect) {\n  sub.tracking = false\n  const depsTail = sub.depsTail\n  /**\n   * 1. \u7ED3\u675F\u8FFD\u8E2A\u540E, \u6709   \u5C3E\u8282\u70B9 \u5E76\u4E14\u8FD8\u6709\u4E0B\u4E00\u4E2A\u8282\u70B9, \u5219\u6E05\u7406\u6389\u4ED6\u4EEC\n   * 2. \u7ED3\u675F\u8FFD\u8E2A\u540E, \u6CA1\u6709 \u5C3E\u8282\u70B9, \u5219\u4ECE\u5934\u90E8\u5F00\u59CB\u6E05\u7406\n   */\n  if (depsTail) {\n    if (depsTail.nextDep) {\n      clearTracking(depsTail.nextDep)\n      depsTail.nextDep = undefined\n    }\n  } else {\n    clearTracking(sub.deps)\n    sub.deps = undefined\n  }\n}\n\n/**\n * \u6E05\u9664\u4F9D\u8D56\u94FE\u8868\u5173\u7CFB\n * @param link\n */\nexport function clearTracking(link: Link) {\n  while (link) {\n    const { nextSub, nextDep, prevSub } = link\n\n    /**\n     * \u5904\u7406\u7EB5\u5411\u94FE\u8868\n     * 1. \u5982\u679C\u6709\u4E0A\u4E00\u4E2A\u8282\u70B9, \u5C31\u5C06\u4E0A\u4E00\u4E2A\u8282\u70B9\u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A\u8282\u70B9, \u4E0B\u4E00\u4E2A\u8282\u70B9\u7684\u4E0A\u4E00\u4E2A\u8282\u70B9\u6307\u5411\n     */\n    if (prevSub) {\n      prevSub.nextSub = nextSub\n      link.nextSub = undefined\n    } else {\n      link.dep.subs = nextSub\n    }\n\n    if (nextSub) {\n      nextDep.prevSub = prevSub\n      link.prevSub = undefined\n    } else {\n      link.dep.subsTail = prevSub\n    }\n\n    // \u9700\u4F18\u5316\n    // link.dep.subs = undefined\n    // link.dep.subsTail = undefined\n    // \u9700\u4F18\u5316end\n\n    link.dep = undefined\n    link.sub = undefined\n\n    link = nextDep\n  }\n}\n", "import { endTrack, Link, startTrack } from './system'\n\ninterface Fn {\n  (...args: any[]): any\n}\n\nexport let activeSub: ReactiveEffect | undefined\n\nexport class ReactiveEffect {\n  deps: Link | undefined\n  depsTail: Link | undefined\n  tracking = false\n\n  constructor(public fn) {}\n  run() {\n    const prevSub = activeSub\n    activeSub = this\n    // if (this.deps && this.deps.dep) {\n    //   this.deps.dep.subsTail = undefined\n    // }\n\n    startTrack(this)\n    try {\n      return this.fn()\n    } finally {\n      endTrack(this)\n      activeSub = prevSub\n    }\n  }\n  scheduler() {\n    this.run()\n  }\n  notify() {\n    this.scheduler()\n  }\n}\n\nexport function effect(fn: Fn, options?: { scheduler?: Fn }) {\n  const e = new ReactiveEffect(fn)\n  if (options) {\n    Object.assign(e, options)\n  }\n  e.run()\n  /**\n   * \u7ED1\u5B9A\u51FD\u6570\u7684 this\n   */\n  const runner = e.run.bind(e)\n\n  /**\n   * \u628A effect \u7684\u5B9E\u4F8B, \u653E\u5230\u51FD\u6570\u5C5E\u6027\u4E2D\n   */\n  runner.effect = e\n  return runner\n}\n", "import { activeSub } from './effect'\nimport { Dep, link, propagate } from './system'\n\nenum ReactiviFlags {\n  IS_REF = '__v_isRef',\n}\n\nexport class RefImpl {\n  // \u4FDD\u5B58\u5B9E\u9645\u7684\u503C\n  _value;\n  // ref \u6807\u8BB0, \u8BC1\u660E\u662F\u4E00\u4E2A ref\n  [ReactiviFlags.IS_REF]: true\n\n  dep = new Dep()\n  constructor(value) {\n    this._value = value\n  }\n  get value() {\n    track(this.dep)\n    return this._value\n  }\n  set value(newValue) {\n    this._value = newValue\n    trigger(this.dep)\n  }\n}\n\n/**\n * \u6536\u96C6\u4F9D\u8D56\n */\nfunction track(dep: Dep) {\n  if (activeSub) {\n    link(dep, activeSub)\n  }\n}\n\n/**\n * \u89E6\u53D1\u66F4\u65B0\n */\nfunction trigger(dep: Dep) {\n  if (dep.subs) {\n    propagate(dep.subs)\n  }\n}\n\nexport function ref(value) {\n  return new RefImpl(value)\n}\n\n/**\n * \u5224\u65AD\u662F\u4E0D\u662F\u4E00\u4E2Aref\n * @param value\n */\nexport function isRef(value) {\n  return !!(value && value[ReactiviFlags.IS_REF])\n}\n"],
  "mappings": "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",
  "names": ["link", "effect"]
}
